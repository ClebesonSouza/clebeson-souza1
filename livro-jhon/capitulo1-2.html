<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BP Monitor PPG v2 Melhorado - 60s Auto</title>
    <style>
        body { font-family: Arial, sans-serif; text-align: center; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; margin: 0; }
        #video { width: 90%; max-width: 350px; height: 250px; border: 3px solid #fff; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.3); }
        #timer { font-size: 56px; font-weight: bold; margin: 20px 0; text-shadow: 0 0 20px currentColor; }
        #hr { font-size: 52px; font-weight: bold; margin: 15px 0; text-shadow: 2px 2px 4px rgba(0,0,0,0.5); }
        #quality { font-size: 24px; margin: 10px; }
        #zone, #risk, #advice { background: rgba(255,255,255,0.2); padding: 15px; border-radius: 10px; margin: 10px auto; max-width: 400px; backdrop-filter: blur(10px); }
        button { background: linear-gradient(45deg, #ff6b6b, #ee5a52); color: white; border: none; padding: 18px 35px; font-size: 20px; border-radius: 30px; cursor: pointer; margin: 10px; box-shadow: 0 10px 25px rgba(0,0,0,0.3); transition: all 0.3s; min-width: 180px; }
        button:hover:not(:disabled) { transform: scale(1.05); box-shadow: 0 15px 35px rgba(0,0,0,0.4); }
        button:disabled { opacity: 0.6; cursor: not-allowed; transform: none; }
        #results { display: none; background: rgba(0,0,0,0.8); padding: 25px; border-radius: 20px; margin: 20px auto; max-width: 90%; backdrop-filter: blur(15px); }
        .stat { font-size: 22px; margin: 15px 0; display: flex; justify-content: space-between; align-items: center; padding: 10px; background: rgba(255,255,255,0.1); border-radius: 8px; }
        #chart { width: 90%; max-width: 400px; height: 180px; border-radius: 15px; margin: 20px auto; background: rgba(255,255,255,0.1); box-shadow: inset 0 0 20px rgba(0,0,0,0.5); }
        #share { background: linear-gradient(45deg, #007bff, #0056b3); }
        .emoji { font-size: 28px; margin-right: 10px; }
    </style>
</head>
<body>
    <video id="video" autoplay playsinline muted style="display:none;"></video>
    <canvas id="canvas" style="display:none;"></canvas>
    
    <div id="measuring">
        <h1 style="margin-bottom: 20px;">ü´Ä BP Monitor v2 Auto</h1>
        <video id="videoView" style="display:block;"></video>
        <canvas id="chart"></canvas>
        <div id="timer">60s</div>
        <div id="hr">Preparando...</div>
        <div id="quality">Qualidade: 0%</div>
        <div id="zone"></div>
        <div id="risk"></div>
        <div id="advice"></div>
        <button id="startBtn">üöÄ Iniciar 60s Auto</button>
    </div>

    <div id="results">
        <h2>üìä Relat√≥rio Final - 60s Medi√ß√£o</h2>
        <div class="stat"><span><span class="emoji">‚ù§Ô∏è</span>BPM M√©dio:</span> <span id="avgBpm">-</span></div>
        <div class="stat"><span><span class="emoji">üìä</span>Desvio Padr√£o:</span> <span id="stdBpm">-</span></div>
        <div class="stat"><span><span class="emoji">‚≠ê</span>Qualidade M√©dia:</span> <span id="avgQuality">-</span></div>
        <div class="stat"><span><span class="emoji">‚¨ÜÔ∏è</span>M√°ximo BPM:</span> <span id="maxBpm">-</span></div>
        <div class="stat"><span><span class="emoji">üéØ</span>Zona Card√≠aca:</span> <span id="finalZone">-</span></div>
        <div class="stat"><span><span class="emoji">‚ö†Ô∏è</span>Risco CV:</span> <span id="finalRisk">-</span></div>
        <canvas id="finalChart" style="width:90%; height:180px; border-radius:15px; margin:20px auto; background:rgba(255,255,255,0.1);"></canvas>
        <button id="shareBtn">üì± Compartilhar Resultados</button>
        <button id="newBtn">üîÑ Nova Medi√ß√£o</button>
    </div>

    <script>
        // Elementos
        const measuringEl = document.getElementById('measuring');
        const resultsEl = document.getElementById('results');
        const videoView = document.getElementById('videoView');
        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const chartCtx = document.getElementById('chart').getContext('2d');
        const finalChartCtx = document.getElementById('finalChart').getContext('2d');
        const timerEl = document.getElementById('timer');
        const hrEl = document.getElementById('hr');
        const qualityEl = document.getElementById('quality');
        const zoneEl = document.getElementById('zone');
        const riskEl = document.getElementById('risk');
        const adviceEl = document.getElementById('advice');
        const startBtn = document.getElementById('startBtn');

        // Vari√°veis
        let stream, animationId, timerInterval;
        let signalBuffer = [], hrHistory = [], qualityHistory = [];
        let isMeasuring = false, timeLeft = 60;
        const SAMPLE_RATE = 30, BUFFER_SIZE = 1800; // 60s

        // Fun√ß√µes principais
        async function initCamera() {
            stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment', width: 640, height: 480 } });
            video.srcObject = stream; video.play();
            videoView.srcObject = stream; // Preview
            canvas.width = 640; canvas.height = 480;
        }

        function processFrame() {
            const ctx = canvas.getContext('2d');
            ctx.drawImage(video, 0, 0);
            const data = ctx.getImageData(0, 0, canvas.width, canvas.height).data;
            let redSum = 0, pixelCount = 0;
            for (let i = 0; i < data.length; i += 4) { redSum += data[i]; pixelCount++; }
            const avgRed = redSum / pixelCount;
            
            signalBuffer.push(avgRed);
            if (signalBuffer.length > BUFFER_SIZE) signalBuffer.shift();
            
            const peaks = findPeaks(signalBuffer.slice(-300));
            const hr = peaks.length > 1 ? 60 / ((peaks[peaks.length-1] - peaks[0]) / (peaks.length - 1) / SAMPLE_RATE) : 0;
            const quality = Math.min(100, Math.max(0, (peaks.length / 15) * 100));
            
            hrHistory.push(hr); qualityHistory.push(quality);
            if (hrHistory.length > 60) { hrHistory.shift(); qualityHistory.shift(); }
            
            const avgHr = hrHistory.reduce((a,b)=>a+b,0) / hrHistory.length;
            updateLiveUI(avgHr, quality);
            updateChart();
        }

        function findPeaks(signal) {
            const peaks = [];
            for (let i = 1; i < signal.length - 1; i++) {
                if (signal[i] > signal[i-1] * 1.02 && signal[i] > signal[i+1] * 1.02) peaks.push(i);
            }
            return peaks.filter((p,i)=> i==0 || p-peaks[i-1]>25);
        }

        function updateLiveUI(hr, quality) {
            hrEl.textContent = Math.round(hr) + ' bpm';
            hrEl.style.color = quality > 70 ? '#00ff88' : quality > 40 ? '#ffaa00' : '#ff4444';
            qualityEl.innerHTML = `Qualidade: ${Math.round(quality)}% ${quality>70?'‚úÖ':'‚ö†Ô∏è'}`;
            timerEl.textContent = timeLeft + 's';
            
            const zone = getZone(hr); zoneEl.innerHTML = `${zone.emoji} ${zone.text}<br><small>${zone.desc}</small>`;
            const risk = getRisk(hr); riskEl.innerHTML = `${risk.color} ${risk.text}<br><small>${risk.advice}</small>`;
            adviceEl.innerHTML = `<strong>Dica:</strong> ${quality>70 ? 'Excelente sinal!' : 'Dedo mais im√≥vel.'}`;
        }

        const getZone = (hr) => hr<60 ? {emoji:'üü¢',text:'Repouso √ìtimo',desc:'Cora√ß√£o saud√°vel.'} :
            hr<80 ? {emoji:'üü¢',text:'Zona 1 Normal',desc:'Perfeito descanso.'} :
            hr<90 ? {emoji:'üü°',text:'Zona 2 Leve',desc:'Relaxamento bom.'} :
            hr<110 ? {emoji:'üü†',text:'Zona 3 Moderado',desc:'Atividade leve.'} : {emoji:'üî¥',text:'Zona 4+ Alto',desc:'Cuide-se!'};

        const getRisk = (hr) => hr<80 ? {color:'üü¢',text:'Baixo Risco',advice:'Excelente!'} :
            hr<100 ? {color:'üü°',text:'Normal',advice:'Mantenha.'} : {color:'üî¥',text:'Aten√ß√£o M√©dica',advice:'Consulte profissional.'};

        function updateChart() {
            const recent = signalBuffer.slice(-150);
            chartCtx.clearRect(0,0,chartCtx.canvas.width,chartCtx.canvas.height);
            const minV = Math.min(...recent), maxV = Math.max(...recent) || 1;
            chartCtx.strokeStyle = '#00ff88'; chartCtx.lineWidth = 3;
            chartCtx.beginPath();
            for (let i=0; i<recent.length; i++) {
                chartCtx.lineTo(i*(chartCtx.canvas.width/150), chartCtx.canvas.height - ((recent[i]-minV)/(maxV-minV))*chartCtx.canvas.height);
            }
            chartCtx.stroke();
        }

        function startMeasurement() {
            initCamera().then(() => {
                measuringEl.querySelector('h1').style.display = 'none';
                videoView.style.display = 'block';
                startBtn.disabled = true;
                isMeasuring = true;
                timeLeft = 60;
                
                timerInterval = setInterval(() => {
                    timeLeft--;
                    if (timeLeft <= 0) { clearInterval(timerInterval); stopMeasurement(); }
                }, 1000);
                
                setTimeout(() => animationId = setInterval(processFrame, 1000/SAMPLE_RATE), 2000);
            });
        }

        function stopMeasurement() {
            clearInterval(animationId);
            if (stream) stream.getTracks().forEach(t=>t.stop());
            showResults();
        }

        function showResults() {
            measuringEl.style.display = 'none';
            resultsEl.style.display = 'block';
            
            const validHr = hrHistory.filter(h=>h>40 && h<200);
            const avgBpm = validHr.reduce((a,b)=>a+b,0)/validHr.length || 0;
            const variance = validHr.reduce((sum,val)=>sum+Math.pow(val-avgBpm,2),0)/validHr.length;
            const stdBpm = Math.sqrt(variance);
            const avgQuality = qualityHistory.reduce((a,b)=>a+b,0)/qualityHistory.length || 0;
            const maxBpm = Math.max(...validHr);
            
            document.getElementById('avgBpm').textContent = avgBpm.toFixed(1);
            document.getElementById('stdBpm').textContent = stdBpm.toFixed(1);
            document.getElementById('avgQuality').textContent = avgQuality.toFixed(0)+'%';
            document.getElementById('maxBpm').textContent = Math.round(maxBpm);
            document.getElementById('finalZone').textContent = getZone(avgBpm).text;
            document.getElementById('finalRisk').textContent = getRisk(avgBpm).text;
            
            drawFinalChart();
        }

        function drawFinalChart() {
            const recent = signalBuffer.slice(-300); // 10s final
            const minV = Math.min(...recent), maxV = Math.max(...recent) || 1;
            finalChartCtx.clearRect(0,0,finalChartCtx.canvas.width,finalChartCtx.canvas.height);
            finalChartCtx.strokeStyle = '#00ff88'; finalChartCtx.lineWidth = 4;
            finalChartCtx.beginPath();
            for (let i=0; i<recent.length; i++) {
                finalChartCtx.lineTo(i*(finalChartCtx.canvas.width/300), finalChartCtx.canvas.height - ((recent[i]-minV)/(maxV-minV))*finalChartCtx.canvas.height);
            }
            finalChartCtx.stroke();
        }

        startBtn.onclick = startMeasurement;
        document.getElementById('newBtn').onclick = () => location.reload();
        document.getElementById('shareBtn').onclick = () => {
            const text = `BP Monitor: ${document.getElementById('avgBpm').textContent} BPM m√©dio | Qualidade ${document.getElementById('avgQuality').textContent} | ${document.getElementById('finalRisk').textContent}`;
            if (navigator.share) navigator.share({title:'Relat√≥rio Card√≠aco',text});
            else navigator.clipboard.writeText(text);
        };
    </script>
</body>
</html>
