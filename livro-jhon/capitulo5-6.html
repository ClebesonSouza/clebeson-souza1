<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BP Monitor PPG - HR Detector</title>
    <style>
        body { font-family: Arial, sans-serif; text-align: center; background: #f0f8ff; padding: 20px; }
        #video { width: 300px; height: 250px; border: 2px solid #007bff; border-radius: 10px; }
        #hr { font-size: 48px; font-weight: bold; color: #dc3545; margin: 20px 0; }
        button { background: #28a745; color: white; border: none; padding: 15px 30px; font-size: 18px; border-radius: 25px; cursor: pointer; margin: 10px; }
        button:hover { background: #218838; }
        button:disabled { background: #6c757d; cursor: not-allowed; }
        #canvas { display: none; }
        .info { background: #e9ecef; padding: 10px; border-radius: 5px; margin: 10px 0; }
    </style>
</head>
<body>
    <h1>游 BP Monitor - Detector de Pulso PPG</h1>
    <video id="video" autoplay playsinline muted></video>
    <canvas id="canvas"></canvas>
    <div id="hr">0 bpm</div>
    <button id="startBtn">Iniciar Medi칞칚o</button>
    <button id="stopBtn" disabled>Parar</button>
    <div class="info">Ponha dedo na c칙mera + flash. Fique im칩vel 30s para melhor precis칚o.</div>

    <script>
        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        const hrDisplay = document.getElementById('hr');
        const startBtn = document.getElementById('startBtn');
        const stopBtn = document.getElementById('stopBtn');

        let stream = null;
        let animationId = null;
        let signalBuffer = [];
        let heartRate = 0;
        const SAMPLE_RATE = 30; // FPS
        const BUFFER_SIZE = 300; // ~10s

        // Inicia c칙mera
        async function initCamera() {
            try {
                stream = await navigator.mediaDevices.getUserMedia({
                    video: { facingMode: 'environment', width: { ideal: 640 }, height: { ideal: 480 } },
                    audio: false
                });
                video.srcObject = stream;
                video.play();
                canvas.width = video.videoWidth || 640;
                canvas.height = video.videoHeight || 480;
            } catch (err) {
                alert('Erro c칙mera: ' + err.message + '\nUse HTTPS e permita c칙mera.');
            }
        }

        // Processa frame para PPG (m칠dia vermelha)
        function processFrame() {
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const data = imageData.data;
            let redSum = 0, pixelCount = 0;

            for (let i = 0; i < data.length; i += 4) {
                redSum += data[i]; // Canal R
                pixelCount++;
            }

            const avgRed = redSum / pixelCount;
            signalBuffer.push(avgRed);
            if (signalBuffer.length > BUFFER_SIZE) signalBuffer.shift();

            if (signalBuffer.length >= 120) { // 4s m칤nimo
                heartRate = calculateHR(signalBuffer);
                hrDisplay.textContent = heartRate.toFixed(1) + ' bpm';
            }

            animationId = requestAnimationFrame(processFrame);
        }

        // Calcula HR simples (filtro + FFT proxy via autocorr)
        function calculateHR(signal) {
            // Filtro bandpass b치sico (0.5-5Hz)
            const filtered = [];
            for (let i = 2; i < signal.length; i++) {
                filtered.push(signal[i] - 0.95 * signal[i-1] + 0.05 * signal[i-2]);
            }

            // Autocorrela칞칚o para per칤odo dominante
            let maxCorr = 0;
            let bestPeriod = 60; // Default 1Hz
            const len = filtered.length;
            for (let lag = 40; lag < 200; lag++) { // 0.2-3Hz
                let corr = 0;
                for (let i = 0; i < len - lag; i++) {
                    corr += filtered[i] * filtered[i + lag];
                }
                if (corr > maxCorr) {
                    maxCorr = corr;
                    bestPeriod = lag;
                }
            }

            return Math.round(60 / (bestPeriod / SAMPLE_RATE));
        }

        startBtn.onclick = () => {
            initCamera().then(() => {
                setTimeout(() => processFrame(), 1000);
                startBtn.disabled = true;
                stopBtn.disabled = false;
            });
        };

        stopBtn.onclick = () => {
            if (animationId) cancelAnimationFrame(animationId);
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
            }
            signalBuffer = [];
            heartRate = 0;
            hrDisplay.textContent = '0 bpm';
            startBtn.disabled = false;
            stopBtn.disabled = true;
        };

        // Auto-inicia se HTTPS
        if (location.protocol === 'https:') initCamera();
    </script>
</body>
</html>
