<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BP Monitor PPG v2 - Preciso + Explica√ß√µes</title>
    <style>
        body { font-family: Arial, sans-serif; text-align: center; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; }
        #video { width: 300px; height: 250px; border: 3px solid #fff; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.3); }
        #hr { font-size: 52px; font-weight: bold; margin: 20px 0; text-shadow: 2px 2px 4px rgba(0,0,0,0.5); }
        #quality { font-size: 24px; margin: 10px; }
        #zone, #risk, #advice { background: rgba(255,255,255,0.2); padding: 15px; border-radius: 10px; margin: 10px auto; max-width: 400px; backdrop-filter: blur(10px); }
        button { background: linear-gradient(45deg, #ff6b6b, #ee5a52); color: white; border: none; padding: 18px 40px; font-size: 20px; border-radius: 30px; cursor: pointer; margin: 15px; box-shadow: 0 8px 20px rgba(0,0,0,0.3); transition: transform 0.2s; }
        button:hover:not(:disabled) { transform: scale(1.05); }
        button:disabled { background: #6c757d; cursor: not-allowed; }
        #chart { width: 100%; height: 150px; border-radius: 10px; margin: 20px 0; background: rgba(255,255,255,0.1); }
        .info { background: rgba(255,255,255,0.15); padding: 15px; border-radius: 10px; margin: 20px; }
    </style>
</head>
<body>
    <h1>ü´Ä BP Monitor PPG v2 - Sa√∫de Card√≠aca</h1>
    <video id="video" autoplay playsinline muted></video>
    <canvas id="canvas" style="display:none;"></canvas>
    <canvas id="chart"></canvas>
    <div id="hr">0 bpm</div>
    <div id="quality">Qualidade: 0%</div>
    <div id="zone"></div>
    <div id="risk"></div>
    <div id="advice"></div>
    <button id="startBtn">üöÄ Iniciar Medi√ß√£o</button>
    <button id="stopBtn" disabled>‚èπÔ∏è Parar</button>
    <div class="info">Dedo na c√¢mera traseira + flash. Fique im√≥vel 1min. Compare com pulso no pesco√ßo!</div>

    <script>
        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const chartCtx = document.getElementById('chart').getContext('2d');
        const hrDisplay = document.getElementById('hr');
        const qualityDisplay = document.getElementById('quality');
        const zoneDiv = document.getElementById('zone');
        const riskDiv = document.getElementById('risk');
        const adviceDiv = document.getElementById('advice');
        const startBtn = document.getElementById('startBtn');
        const stopBtn = document.getElementById('stopBtn');

        let stream = null;
        let animationId = null;
        let signalBuffer = [];
        let peaks = [];
        let heartRate = 0;
        let quality = 0;
        let avgHr = 0;
        const SAMPLE_RATE = 30;
        const BUFFER_SIZE = 1800; // 1min
        const chartData = { signal: [], peaks: [] };

        async function initCamera() {
            try {
                stream = await navigator.mediaDevices.getUserMedia({
                    video: { facingMode: 'environment', width: { ideal: 640 }, height: { ideal: 480 } }
                });
                video.srcObject = stream;
                video.play();
                canvas.width = 640;
                canvas.height = 480;
            } catch (err) {
                alert('Erro: ' + err + '\nHTTPS + permita c√¢mera!');
            }
        }

        function processFrame() {
            const ctx = canvas.getContext('2d');
            ctx.drawImage(video, 0, 0);
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height).data;
            let redSum = 0, pixelCount = 0;
            for (let i = 0; i < imageData.length; i += 4) {
                redSum += imageData[i];
                pixelCount++;
            }
            const avgRed = redSum / pixelCount;
            signalBuffer.push(avgRed);
            if (signalBuffer.length > BUFFER_SIZE) signalBuffer.shift();

            peaks = findPeaks(signalBuffer.slice(-300)); // √öltimos 10s
            heartRate = calculateHR(peaks);
            quality = Math.min(100, (peaks.length / 15) * 100); // Picos esperados ~1.25/seg
            avgHr = signalBuffer.length > 900 ? calculateAvgHR() : heartRate; // M√©dia 30s

            updateDisplay();
            updateChart();
            animationId = requestAnimationFrame(processFrame);
        }

        function findPeaks(signal) {
            const peaks = [];
            for (let i = 1; i < signal.length - 1; i++) {
                if (signal[i] > signal[i-1] && signal[i] > signal[i+1]) peaks.push(i);
            }
            return peaks.filter((p, idx) => idx === 0 || p - peaks[idx-1] > 20); // Anti-ru√≠do
        }

        function calculateHR(peaks) {
            if (peaks.length < 2) return heartRate;
            const interval = (peaks[peaks.length-1] - peaks[0]) / (peaks.length - 1) / SAMPLE_RATE * 60;
            return Math.max(40, Math.min(200, interval));
        }

        function calculateAvgHR() {
            const recentPeaks = peaks.slice(-30); // √öltimo min
            if (recentPeaks.length < 2) return heartRate;
            return 60 / ((recentPeaks[recentPeaks.length-1] - recentPeaks[0]) / (recentPeaks.length - 1) / SAMPLE_RATE);
        }

        function getZone(hr) {
            if (hr < 60) return { emoji: 'üü¢', text: 'Zona 1: Repouso √≥timo', desc: 'Cora√ß√£o saud√°vel em descanso.' };
            if (hr < 70) return { emoji: 'üü¢', text: 'Zona 1: Muito leve', desc: 'Ideal para recupera√ß√£o.' };
            if (hr < 80) return { emoji: 'üü°', text: 'Zona 2: Leve', desc: 'Queima gordura, bom para sa√∫de.' };
            if (hr < 90) return { emoji: 'üü†', text: 'Zona 3: Moderado', desc: 'Melhora endurance.' };
            if (hr < 110) return { emoji: 'üü†', text: 'Zona 4: Intenso', desc: 'Treino forte, ok curto prazo.' };
            return { emoji: 'üî¥', text: 'Zona 5: M√°ximo/Alto', desc: 'Risco se persistir em repouso!' };
        }

        function getRisk(hr) {
            if (hr < 60) return { color: 'üü¢', text: 'Baixo risco CV', advice: '√ìtimo! Continue assim.' };
            if (hr < 80) return { color: 'üü¢', text: 'Normal', advice: 'Saud√°vel.' };
            if (hr < 100) return { color: 'üü°', text: 'Aten√ß√£o leve', advice: 'Respire fundo, relaxe.' };
            return { color: 'üî¥', text: 'Alto - Consulte m√©dico', advice: 'Pode indicar estresse/hipertens√£o.' };
        }

        function updateDisplay() {
            hrDisplay.textContent = avgHr.toFixed(1) + ' bpm';
            hrDisplay.style.color = quality > 70 ? '#00ff88' : quality > 40 ? '#ffaa00' : '#ff4444';
            qualityDisplay.textContent = `Qualidade: ${quality.toFixed(0)}% ${quality > 70 ? '‚úÖ Boa' : quality > 40 ? '‚ö†Ô∏è M√©dia' : '‚ùå Ruim'}`;
            const zone = getZone(avgHr);
            zoneDiv.innerHTML = `${zone.emoji} ${zone.text}<br><small>${zone.desc}</small>`;
            const risk = getRisk(avgHr);
            riskDiv.innerHTML = `${risk.color} Risco CV: ${risk.text}<br><small>${risk.advice}</small>`;
            adviceDiv.innerHTML = `<strong>Dica:</strong> ${quality > 70 ? 'Medi√ß√£o precisa! Compare com pulso.' : 'Melhore: dedo im√≥vel, luz baixa.'}`;
        }

        function updateChart() {
            const chart = document.getElementById('chart');
            const ctx = chartCtx;
            ctx.clearRect(0, 0, chart.width, chart.height);
            const recentSignal = signalBuffer.slice(-150); // 5s
            const scaleY = chart.height / 100;
            ctx.strokeStyle = quality > 70 ? '#00ff88' : '#ff4444';
            ctx.lineWidth = 2;
            ctx.beginPath();
            for (let i = 0; i < recentSignal.length; i++) {
                ctx.lineTo(i * 2, chart.height - (recentSignal[i] % 100) * scaleY);
            }
            ctx.stroke();

            // Picos
            peaks.slice(-75).forEach(p => {
                ctx.fillStyle = '#ffff00';
                ctx.beginPath();
                ctx.arc((p % 150) * 2, chart.height - (recentSignal[p % 150] % 100) * scaleY, 4, 0, Math.PI * 2);
                ctx.fill();
            });
        }

        startBtn.onclick = () => {
            initCamera().then(() => setTimeout(processFrame, 1000));
            startBtn.disabled = true;
            stopBtn.disabled = false;
        };

        stopBtn.onclick = () => {
            if (animationId) cancelAnimationFrame(animationId);
            if (stream) stream.getTracks().forEach(track => track.stop());
            signalBuffer = []; peaks = [];
            updateDisplay();
            startBtn.disabled = false;
            stopBtn.disabled = true;
        };
    </script>
</body>
</html>
