<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SpO2 Monitor - Oximetro via Camera</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: Arial, sans-serif;
            background: linear-gradient(135deg, #0a0a2e 0%, #1a1a4e 100%);
            color: white;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            padding: 20px;
            text-align: center;
        }
        h1 { font-size: clamp(22px,6vw,34px); margin-bottom: 10px; }
        .instruction {
            background: rgba(255,255,255,0.1);
            padding: 12px 20px;
            border-radius: 15px;
            font-size: clamp(13px,3.5vw,17px);
            margin-bottom: 15px;
            max-width: 400px;
        }
        #videoView {
            width: 90vw; max-width: 350px; height: 230px;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(255,50,50,0.4);
            border: 4px solid rgba(255,100,100,0.5);
            display: none;
            margin-bottom: 10px;
        }
        #chart {
            width: 90vw; max-width: 400px;
            height: clamp(100px,22vw,160px);
            border-radius: 15px;
            margin: 10px auto;
            background: rgba(255,255,255,0.05);
            box-shadow: inset 0 0 20px rgba(0,0,0,0.5);
            display: block;
        }
        #timer { font-size: clamp(28px,8vw,52px); font-weight: 900; margin: 10px 0; }
        .metrics-row {
            display: flex; gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
            margin: 10px 0;
        }
        .metric-box {
            background: rgba(255,255,255,0.1);
            border-radius: 18px;
            padding: 15px 25px;
            min-width: 140px;
            backdrop-filter: blur(10px);
        }
        .metric-label { font-size: 15px; opacity: 0.8; margin-bottom: 5px; }
        .metric-value { font-size: clamp(36px,10vw,58px); font-weight: 900; }
        #quality-bar-wrap {
            width: 90vw; max-width: 400px;
            background: rgba(255,255,255,0.1);
            border-radius: 10px;
            height: 18px;
            margin: 8px auto;
            overflow: hidden;
        }
        #quality-bar {
            height: 100%;
            width: 0%;
            background: linear-gradient(90deg, #ff4444, #ffaa00, #00ff88);
            border-radius: 10px;
            transition: width 0.5s;
        }
        #status {
            font-size: clamp(14px,4vw,20px);
            padding: 12px 20px;
            border-radius: 15px;
            margin: 8px 0;
            background: rgba(255,255,255,0.1);
            max-width: 400px;
        }
        button {
            background: linear-gradient(45deg, #ff4444, #cc0000);
            border: none; color: white;
            padding: 18px 35px;
            font-size: clamp(15px,5vw,20px);
            font-weight: bold;
            border-radius: 50px;
            cursor: pointer;
            margin: 10px 5px;
            box-shadow: 0 12px 30px rgba(255,68,68,0.5);
            transition: all 0.3s;
            min-height: 60px; min-width: 220px;
        }
        button:hover:not(:disabled) { transform: scale(1.05); }
        button:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
        #btnNew { background: linear-gradient(45deg,#00ff88,#00cc6a); color: black; }
        #btnShare { background: linear-gradient(45deg,#007bff,#0056b3); }
        #results {
            display: none;
            padding: 25px;
            background: rgba(0,0,0,0.9);
            border-radius: 25px;
            max-width: 95vw;
            width: 400px;
            backdrop-filter: blur(20px);
            margin-top: 15px;
        }
        .stat {
            font-size: clamp(15px,4vw,20px);
            margin: 12px 0; padding: 15px;
            background: rgba(255,68,68,0.15);
            border-radius: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .good { color: #00ff88; font-weight: bold; }
        .alert { color: #ffaa00; font-weight: bold; }
        .warn { color: #ff4444; font-weight: bold; }
    </style>
</head>
<body>

    <h1>ü©∏ SpO2 Monitor</h1>
    <p class="instruction">
        Coloque o <strong>dedo na c√¢mera traseira + flash</strong>.<br>
        Fique <strong>im√≥vel</strong> durante 60 segundos.
    </p>

    <video id="videoView" autoplay playsinline muted></video>
    <canvas id="chart"></canvas>

    <div id="timer">60s</div>

    <div class="metrics-row">
        <div class="metric-box">
            <div class="metric-label">ü©∏ SpO2</div>
            <div class="metric-value" id="spo2" style="color:#ff4444;">--%</div>
        </div>
        <div class="metric-box">
            <div class="metric-label">‚ù§Ô∏è BPM</div>
            <div class="metric-value" id="bpm" style="color:#00ff88;">--</div>
        </div>
    </div>

    <div id="quality-bar-wrap"><div id="quality-bar"></div></div>
    <div id="status">Toque em Iniciar e coloque o dedo na c√¢mera.</div>

    <button id="btnStart">‚ù§Ô∏è Iniciar Medi√ß√£o 60s</button>

    <div id="results">
        <h2 style="font-size:clamp(20px,6vw,28px); margin-bottom:20px;">üìä Relat√≥rio SpO2</h2>
        <div class="stat"><span>ü©∏ SpO2 M√©dio</span><span id="rSpo2">--</span></div>
        <div class="stat"><span>‚ù§Ô∏è BPM M√©dio</span><span id="rBpm">--</span></div>
        <div class="stat"><span>üìà Desvio SpO2</span><span id="rStd">--</span></div>
        <div class="stat"><span>‚≠ê Qualidade</span><span id="rQuality">--</span></div>
        <div class="stat"><span>‚ö†Ô∏è Status</span><span id="rStatus">--</span></div>
        <div class="stat"><span>üí° Diagn√≥stico</span><span id="rDiag">--</span></div>
        <button id="btnShare">üì± Compartilhar</button>
        <button id="btnNew">üîÑ Nova Medi√ß√£o</button>
    </div>

    <script>
        const videoView = document.getElementById("videoView");
        const chart     = document.getElementById("chart");
        const cCtx      = chart.getContext("2d");
        const timerEl   = document.getElementById("timer");
        const spo2El    = document.getElementById("spo2");
        const bpmEl     = document.getElementById("bpm");
        const statusEl  = document.getElementById("status");
        const btnStart  = document.getElementById("btnStart");
        const resultsEl = document.getElementById("results");
        const qualBar   = document.getElementById("quality-bar");

        let stream = null, animId = null, timerInt = null, timeLeft = 60;
        const FPS = 30;
        let redBuf = [], greenBuf = [], spo2Buf = [], hrBuf = [], qualBuf = [];

        async function initCamera() {
            try {
                stream = await navigator.mediaDevices.getUserMedia({
                    video: { facingMode: "environment", width:{ideal:640}, height:{ideal:480}, frameRate:{ideal:FPS} }
                });
                videoView.srcObject = stream;
                await videoView.play();
                videoView.style.display = "block";
                chart.width  = chart.offsetWidth  || 360;
                chart.height = chart.offsetHeight || 140;
                return true;
            } catch (e) {
                alert("Erro c√¢mera: " + e.message + "\nHabilite HTTPS + permita c√¢mera!");
                return false;
            }
        }

        function extractRGB() {
            const tmp = document.createElement("canvas");
            tmp.width = 640; tmp.height = 480;
            const tc = tmp.getContext("2d");
            tc.drawImage(videoView, 0, 0, 640, 480);
            const roi = tc.getImageData(160, 120, 320, 240).data;
            let r = 0, g = 0, b = 0, n = 0;
            for (let i = 0; i < roi.length; i += 4) { r+=roi[i]; g+=roi[i+1]; b+=roi[i+2]; n++; }
            return { r:r/n, g:g/n, b:b/n };
        }

        function calcSpO2() {
            if (redBuf.length < FPS * 4) return 0;
            const R = redBuf.slice(-120), G = greenBuf.slice(-120);
            const acR = Math.max(...R) - Math.min(...R);
            const dcR = R.reduce((a,b)=>a+b) / R.length;
            const acG = Math.max(...G) - Math.min(...G);
            const dcG = G.reduce((a,b)=>a+b) / G.length;
            if (!dcR || !dcG || !acG) return 0;
            const RR = (acR/dcR) / (acG/dcG);
            return Math.min(100, Math.max(70, 110 - 25 * RR));
        }

        function calcBPM() {
            if (greenBuf.length < 60) return 0;
            const sig = greenBuf.slice(-120);
            const filt = [];
            for (let i = 2; i < sig.length; i++)
                filt.push(sig[i] - 0.98*sig[i-1] + 0.02*sig[i-2]);
            const peaks = [];
            for (let i = 5; i < filt.length - 5; i++) {
                if (filt[i] > filt[i-1]*1.015 && filt[i] > filt[i+1]*1.015 &&
                    (peaks.length === 0 || i - peaks[peaks.length-1] > 20))
                    peaks.push(i);
            }
            if (peaks.length < 3) return 0;
            const avg = (peaks[peaks.length-1] - peaks[0]) / (peaks.length - 1);
            return Math.min(200, Math.max(40, Math.round(60 * FPS / avg)));
        }

        function calcQuality() {
            if (redBuf.length < 30) return 0;
            const R = redBuf.slice(-60);
            const amp  = Math.max(...R) - Math.min(...R);
            const mean = R.reduce((a,b)=>a+b) / R.length;
            return Math.min(100, Math.max(0, (amp/mean)*1500));
        }

        function getDiag(spo2) {
            if (spo2 >= 95) return { label:"Normal ‚úÖ", cls:"good" };
            if (spo2 >= 90) return { label:"Aten√ß√£o ‚ö†Ô∏è", cls:"alert" };
            if (spo2 >= 85) return { label:"Hipoxemia Leve üî∂", cls:"alert" };
            return { label:"Hipoxemia Grave üö®", cls:"warn" };
        }

        function drawChart() {
            cCtx.clearRect(0, 0, chart.width, chart.height);
            const sig = redBuf.slice(-200);
            if (sig.length < 5) return;
            const minV = Math.min(...sig), maxV = Math.max(...sig);
            if (maxV === minV) return;
            cCtx.strokeStyle = "#ff4444";
            cCtx.lineWidth = 3;
            cCtx.lineCap = "round";
            cCtx.lineJoin = "round";
            cCtx.beginPath();
            for (let i = 0; i < sig.length; i++) {
                const x = (i / sig.length) * chart.width;
                const y = chart.height - ((sig[i]-minV)/(maxV-minV)) * chart.height;
                i === 0 ? cCtx.moveTo(x,y) : cCtx.lineTo(x,y);
            }
            cCtx.stroke();
        }

        function processFrame() {
            const { r, g } = extractRGB();
            redBuf.push(r); greenBuf.push(g);
            if (redBuf.length > FPS*60) { redBuf.shift(); greenBuf.shift(); }

            const spo2 = calcSpO2();
            const bpm  = calcBPM();
            const qual = calcQuality();

            if (spo2 > 0) { spo2Buf.push(spo2); if (spo2Buf.length > 100) spo2Buf.shift(); }
            if (bpm  > 0) { hrBuf.push(bpm);    if (hrBuf.length   > 100) hrBuf.shift();   }
            qualBuf.push(qual); if (qualBuf.length > 30) qualBuf.shift();

            const avgSpo2 = spo2Buf.length ? spo2Buf.reduce((a,b)=>a+b)/spo2Buf.length : 0;
            const avgBpm  = hrBuf.length   ? hrBuf.reduce((a,b)=>a+b)/hrBuf.length     : 0;
            const avgQual = qualBuf.reduce((a,b)=>a+b)/qualBuf.length;

            spo2El.textContent = avgSpo2 > 0 ? avgSpo2.toFixed(1)+"%" : "--%";
            spo2El.style.color = avgSpo2 >= 95 ? "#00ff88" : avgSpo2 >= 90 ? "#ffaa00" : "#ff4444";
            bpmEl.textContent  = avgBpm > 0 ? Math.round(avgBpm) : "--";

            qualBar.style.width = Math.round(avgQual)+"%";
            statusEl.textContent = avgQual > 70
                ? "‚úÖ Sinal bom! Mantenha dedo im√≥vel."
                : avgQual > 40
                    ? "‚ö†Ô∏è Sinal m√©dio ‚Äì pressione mais o dedo."
                    : "‚ùå Sinal fraco ‚Äì use flash + ambiente escuro.";

            timerEl.textContent = timeLeft + "s";
            drawChart();
        }

        btnStart.onclick = async () => {
            btnStart.disabled = true;
            btnStart.textContent = "üìπ Iniciando c√¢mera...";
            if (!await initCamera()) {
                btnStart.disabled = false;
                btnStart.textContent = "‚ù§Ô∏è Iniciar Medi√ß√£o 60s";
                return;
            }
            btnStart.textContent = "Medindo 60s...";
            timeLeft = 60;
            timerInt = setInterval(() => {
                timeLeft--;
                if (timeLeft <= 0) { clearInterval(timerInt); endMeasurement(); }
            }, 1000);
            animId = setInterval(processFrame, 1000/FPS);
        };

        function endMeasurement() {
            clearInterval(animId);
            if (stream) stream.getTracks().forEach(t => t.stop());

            const avgSpo2 = spo2Buf.length ? spo2Buf.reduce((a,b)=>a+b)/spo2Buf.length : 0;
            const avgBpm  = hrBuf.length   ? hrBuf.reduce((a,b)=>a+b)/hrBuf.length     : 0;
            const avgQual = qualBuf.reduce((a,b)=>a+b)/qualBuf.length;
            const variance = spo2Buf.length > 1
                ? spo2Buf.reduce((s,v) => s+(v-avgSpo2)**2, 0)/spo2Buf.length : 0;
            const std = Math.sqrt(variance);
            const diag = getDiag(avgSpo2);

            document.getElementById("rSpo2").textContent    = avgSpo2.toFixed(1)+"%";
            document.getElementById("rBpm").textContent     = Math.round(avgBpm);
            document.getElementById("rStd").textContent     = "¬±"+std.toFixed(1)+"%";
            document.getElementById("rQuality").textContent = Math.round(avgQual)+"%";
            document.getElementById("rStatus").innerHTML    = `<span class="${diag.cls}">${diag.label}</span>`;
            document.getElementById("rDiag").innerHTML      =
                avgSpo2 >= 95
                    ? '<span class="good">Oxigena√ß√£o normal ‚úÖ</span>'
                    : avgSpo2 >= 90
                        ? '<span class="alert">Monitorar de perto ‚ö†Ô∏è</span>'
                        : '<span class="warn">Procure m√©dico! üö®</span>';

            const history = JSON.parse(localStorage.getItem("spo2History") || "[]");
            history.push({
                date: new Date().toLocaleString("pt-BR"),
                spo2: avgSpo2.toFixed(1),
                bpm: Math.round(avgBpm),
                quality: Math.round(avgQual)
            });
            localStorage.setItem("spo2History", JSON.stringify(history));

            resultsEl.style.display = "block";
            resultsEl.scrollIntoView({ behavior:"smooth" });
        }

        document.getElementById("btnShare").onclick = () => {
            const txt = `ü©∏ SpO2: ${document.getElementById("rSpo2").textContent} | ‚ù§Ô∏è BPM: ${document.getElementById("rBpm").textContent} | Diagn√≥stico: ${document.getElementById("rDiag").innerText}`;
            if (navigator.share) navigator.share({ title:"Meu SpO2", text:txt });
            else navigator.clipboard.writeText(txt).then(() => alert("Copiado para √°rea de transfer√™ncia!"));
        };

        document.getElementById("btnNew").onclick = () => location.reload();
    </script>
</body>
</html>
